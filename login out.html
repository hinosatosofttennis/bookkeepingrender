<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ­ã‚°ã‚¤ãƒ³</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <!-- é€šçŸ¥è¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden">
        <div id="notification-content" class="px-6 py-3 rounded-lg shadow-lg text-white font-medium">
            <span id="notification-message"></span>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
                <span class="text-gray-700">ãƒ­ã‚°ã‚¤ãƒ³ä¸­...</span>
            </div>
        </div>
    </div>

    <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6 text-center">ãƒ­ã‚°ã‚¤ãƒ³</h2>
        
        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="error-message" class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden">
        </div>
        
        <form id="login-form" novalidate>
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input 
                    type="email" 
                    id="email" 
                    required 
                    autocomplete="email"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="example@email.com"
                >
                <div id="email-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>
            
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="password" 
                        required 
                        autocomplete="current-password"
                        minlength="6"
                        class="mt-1 block w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
                    >
                    <button 
                        type="button" 
                        id="toggle-password" 
                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm text-gray-600 hover:text-gray-800"
                        tabindex="-1"
                    >
                        ğŸ‘ï¸
                    </button>
                </div>
                <div id="password-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>

            <!-- Remember Me & Forgot Password -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <input 
                        id="remember-me" 
                        name="remember-me" 
                        type="checkbox" 
                        class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                    >
                    <label for="remember-me" class="ml-2 block text-sm text-gray-700">
                        ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ä¿æŒ
                    </label>
                </div>
                <div class="text-sm">
                    <a href="#" id="forgot-password" class="font-medium text-indigo-600 hover:text-indigo-500">
                        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸæ–¹
                    </a>
                </div>
            </div>
            
            <button 
                type="submit" 
                id="login-btn"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                ãƒ­ã‚°ã‚¤ãƒ³
            </button>
        </form>
        
        <p class="text-center text-sm mt-4">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ <a href="register.html" class="text-indigo-600 hover:underline">æ–°è¦ç™»éŒ²</a>
        </p>
    </div>

    <script>
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        const Utils = {
            // é€šçŸ¥è¡¨ç¤º
            showNotification(message, type = 'info', duration = 5000) {
                const notification = document.getElementById('notification');
                const content = document.getElementById('notification-content');
                const messageEl = document.getElementById('notification-message');
                
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                content.className = `px-6 py-3 rounded-lg shadow-lg text-white font-medium ${colors[type]}`;
                messageEl.textContent = message;
                notification.classList.remove('hidden');
                
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, duration);
            },
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºåˆ¶å¾¡
            showLoading() {
                document.getElementById('loading-overlay').classList.remove('hidden');
            },
            
            hideLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
            },
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
            showError(message) {
                const errorEl = document.getElementById('error-message');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            },
            
            hideError() {
                document.getElementById('error-message').classList.add('hidden');
            },
            
            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
            showFieldError(fieldId, message) {
                const errorEl = document.getElementById(`${fieldId}-error`);
                const inputEl = document.getElementById(fieldId);
                
                if (errorEl && inputEl) {
                    errorEl.textContent = message;
                    errorEl.classList.remove('hidden');
                    inputEl.classList.add('border-red-500');
                }
            },
            
            clearFieldError(fieldId) {
                const errorEl = document.getElementById(`${fieldId}-error`);
                const inputEl = document.getElementById(fieldId);
                
                if (errorEl && inputEl) {
                    errorEl.classList.add('hidden');
                    inputEl.classList.remove('border-red-500');
                }
            },
            
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }
        };

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿
        document.getElementById('toggle-password').addEventListener('click', () => {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.getElementById('toggle-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'ğŸ™ˆ';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'ğŸ‘ï¸';
            }
        });

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value;
            Utils.clearFieldError('email');
            
            if (email && !Utils.validateEmail(email)) {
                Utils.showFieldError('email', 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
        });

        document.getElementById('password').addEventListener('blur', function() {
            const password = this.value;
            Utils.clearFieldError('password');
            
            if (password && password.length < 6) {
                Utils.showFieldError('password', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
        });

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        ['email', 'password'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('focus', () => {
                Utils.clearFieldError(fieldId);
                Utils.hideError();
            });
        });

        // ãƒ¡ã‚¤ãƒ³ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            Utils.hideError();
            ['email', 'password'].forEach(fieldId => Utils.clearFieldError(fieldId));
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            let hasError = false;
            
            if (!email) {
                Utils.showFieldError('email', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                hasError = true;
            } else if (!Utils.validateEmail(email)) {
                Utils.showFieldError('email', 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                hasError = true;
            }
            
            if (!password) {
                Utils.showFieldError('password', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                hasError = true;
            } else if (password.length < 6) {
                Utils.showFieldError('password', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
                hasError = true;
            }
            
            if (hasError) return;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
            Utils.showLoading();
            loginBtn.disabled = true;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest' // CSRFãƒ—ãƒ­ãƒ†ã‚¯ã‚·ãƒ§ãƒ³
                    },
                    body: JSON.stringify({ email, password, rememberMe }),
                    credentials: 'same-origin' // Cookieã‚’å«ã‚ã‚‹
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    // ãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜ï¼ˆæœ‰åŠ¹æœŸé™ã‚‚å«ã‚ã‚‹ï¼‰
                    const storage = rememberMe ? localStorage : sessionStorage;
                    storage.setItem('authToken', result.token);
                    
                    if (result.expiresAt) {
                        storage.setItem('tokenExpiry', result.expiresAt);
                    }
                    
                    if (result.user) {
                        storage.setItem('userInfo', JSON.stringify(result.user));
                    }
                    
                    Utils.showNotification('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success', 2000);
                    
                    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã‚’æ±ºå®š
                    const redirectUrl = sessionStorage.getItem('redirectAfterLogin') || 'bookkeepingsystem.html';
                    sessionStorage.removeItem('redirectAfterLogin');
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1000);
                    
                } else {
                    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
                    const errorMessage = result.error || result.message || 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    Utils.showError(errorMessage);
                    
                    // ç‰¹å®šã®ã‚¨ãƒ©ãƒ¼ã«å¯¾ã™ã‚‹å‡¦ç†
                    if (result.field) {
                        Utils.showFieldError(result.field, errorMessage);
                    }
                }
                
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    Utils.showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else {
                    Utils.showError('ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
                
            } finally {
                Utils.hideLoading();
                loginBtn.disabled = false;
            }
        });

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã®å‡¦ç†
        document.getElementById('forgot-password').addEventListener('click', (e) => {
            e.preventDefault();
            // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®å‡¦ç†ã‚’å®Ÿè£…
            Utils.showNotification('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™', 'info');
        });

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', () => {
            // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã®ãƒã‚§ãƒƒã‚¯
            const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            if (token) {
                const expiry = localStorage.getItem('tokenExpiry') || sessionStorage.getItem('tokenExpiry');
                if (!expiry || Date.now() < new Date(expiry).getTime()) {
                    // æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚‹å ´åˆã¯ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    window.location.href = 'bookkeepingsystem.html';
                }
            }
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                Utils.showError(decodeURIComponent(error));
            }
        });
    </script>
</body>
</html>

<!-- ===== æ–°è¦ç™»éŒ²ãƒšãƒ¼ã‚¸ ===== -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <!-- é€šçŸ¥è¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden">
        <div id="notification-content" class="px-6 py-3 rounded-lg shadow-lg text-white font-medium">
            <span id="notification-message"></span>
        </div>
    </div>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
                <span class="text-gray-700">ç™»éŒ²ä¸­...</span>
            </div>
        </div>
    </div>

    <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6 text-center">æ–°è¦ç™»éŒ²</h2>
        
        <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div id="error-message" class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden">
        </div>
        
        <form id="register-form" novalidate>
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                <input 
                    type="email" 
                    id="email" 
                    required 
                    autocomplete="email"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="example@email.com"
                >
                <div id="email-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>
            
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="password" 
                        required 
                        autocomplete="new-password"
                        minlength="8"
                        class="mt-1 block w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="8æ–‡å­—ä»¥ä¸Šã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
                    >
                    <button 
                        type="button" 
                        id="toggle-password" 
                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm text-gray-600 hover:text-gray-800"
                        tabindex="-1"
                    >
                        ğŸ‘ï¸
                    </button>
                </div>
                <div id="password-error" class="text-red-600 text-sm mt-1 hidden"></div>
                <div class="text-xs text-gray-500 mt-1">
                    8æ–‡å­—ä»¥ä¸Šã§ã€è‹±æ•°å­—ã‚’å«ã‚ã¦ãã ã•ã„
                </div>
            </div>

            <div class="mb-6">
                <label for="confirm-password" class="block text-sm font-medium text-gray-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
                <input 
                    type="password" 
                    id="confirm-password" 
                    required 
                    autocomplete="new-password"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å†å…¥åŠ›"
                >
                <div id="confirm-password-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>

            <!-- åˆ©ç”¨è¦ç´„åŒæ„ -->
            <div class="mb-6">
                <div class="flex items-center">
                    <input 
                        id="agree-terms" 
                        name="agree-terms" 
                        type="checkbox" 
                        required
                        class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                    >
                    <label for="agree-terms" class="ml-2 block text-sm text-gray-700">
                        <a href="#" class="text-indigo-600 hover:text-indigo-500">åˆ©ç”¨è¦ç´„</a>ã¨<a href="#" class="text-indigo-600 hover:text-indigo-500">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã—ã¾ã™
                    </label>
                </div>
                <div id="agree-terms-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>
            
            <button 
                type="submit" 
                id="register-btn"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                ç™»éŒ²ã™ã‚‹
            </button>
        </form>
        
        <p class="text-center text-sm mt-4">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ <a href="login.html" class="text-indigo-600 hover:underline">ãƒ­ã‚°ã‚¤ãƒ³</a>
        </p>
    </div>

    <script>
        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¨åŒã˜ã‚‚ã®ã‚’å†åˆ©ç”¨ï¼‰
        const Utils = {
            showNotification(message, type = 'info', duration = 5000) {
                const notification = document.getElementById('notification');
                const content = document.getElementById('notification-content');
                const messageEl = document.getElementById('notification-message');
                
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                content.className = `px-6 py-3 rounded-lg shadow-lg text-white font-medium ${colors[type]}`;
                messageEl.textContent = message;
                notification.classList.remove('hidden');
                
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, duration);
            },
            
            showLoading() {
                document.getElementById('loading-overlay').classList.remove('hidden');
            },
            
            hideLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
            },
            
            showError(message) {
                const errorEl = document.getElementById('error-message');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            },
            
            hideError() {
                document.getElementById('error-message').classList.add('hidden');
            },
            
            showFieldError(fieldId, message) {
                const errorEl = document.getElementById(`${fieldId}-error`);
                const inputEl = document.getElementById(fieldId);
                
                if (errorEl && inputEl) {
                    errorEl.textContent = message;
                    errorEl.classList.remove('hidden');
                    inputEl.classList.add('border-red-500');
                }
            },
            
            clearFieldError(fieldId) {
                const errorEl = document.getElementById(`${fieldId}-error`);
                const inputEl = document.getElementById(fieldId);
                
                if (errorEl && inputEl) {
                    errorEl.classList.add('hidden');
                    inputEl.classList.remove('border-red-500');
                }
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePassword(password) {
                // 8æ–‡å­—ä»¥ä¸Šã§è‹±æ•°å­—ã‚’å«ã‚€
                return password.length >= 8 && /[a-zA-Z]/.test(password) && /[0-9]/.test(password);
            }
        };

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿
        document.getElementById('toggle-password').addEventListener('click', () => {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.getElementById('toggle-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'ğŸ™ˆ';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'ğŸ‘ï¸';
            }
        });

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value;
            Utils.clearFieldError('email');
            
            if (email && !Utils.validateEmail(email)) {
                Utils.showFieldError('email', 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
        });

        document.getElementById('password').addEventListener('input', function() {
            const password = this.value;
            Utils.clearFieldError('password');
            
            if (password && !Utils.validatePassword(password)) {
                Utils.showFieldError('password', '8æ–‡å­—ä»¥ä¸Šã§è‹±æ•°å­—ã‚’å«ã‚ã¦ãã ã•ã„');
            }
            
            // ç¢ºèªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚‚ãƒã‚§ãƒƒã‚¯
            const confirmPassword = document.getElementById('confirm-password').value;
            if (confirmPassword && password !== confirmPassword) {
                Utils.showFieldError('confirm-password', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
            } else if (confirmPassword && password === confirmPassword) {
                Utils.clearFieldError('confirm-password');
            }
        });

        document.getElementById('confirm-password').addEventListener('blur', function() {
            const confirmPassword = this.value;
            const password = document.getElementById('password').value;
            Utils.clearFieldError('confirm-password');
            
            if (confirmPassword && password !== confirmPassword) {
                Utils.showFieldError('confirm-password', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
            }
        });

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        ['email', 'password', 'confirm-password', 'agree-terms'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('focus', () => {
                Utils.clearFieldError(fieldId);
                Utils.hideError();
            });
        });

        // ãƒ¡ã‚¤ãƒ³ã®ç™»éŒ²å‡¦ç†
        const registerForm = document.getElementById('register-form');
        const registerBtn = document.getElementById('register-btn');
        
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            Utils.hideError();
            ['email', 'password', 'confirm-password', 'agree-terms'].forEach(fieldId => Utils.clearFieldError(fieldId));
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const agreeTerms = document.getElementById('agree-terms').checked;
            
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            let hasError = false;
            
            if (!email) {
                Utils.showFieldError('email', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                hasError = true;
            } else if (!Utils.validateEmail(email)) {
                Utils.showFieldError('email', 'æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                hasError = true;
            }
            
            if (!password) {
                Utils.showFieldError('password', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                hasError = true;
            } else if (!Utils.validatePassword(password)) {
                Utils.showFieldError('password', '8æ–‡å­—ä»¥ä¸Šã§è‹±æ•°å­—ã‚’å«ã‚ã¦ãã ã•ã„');
                hasError = true;
            }
            
            if (!confirmPassword) {
                Utils.showFieldError('confirm-password', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                hasError = true;
            } else if (password !== confirmPassword) {
                Utils.showFieldError('confirm-password', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“');
                hasError = true;
            }
            
            if (!agreeTerms) {
                Utils.showFieldError('agree-terms', 'åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ã¦ãã ã•ã„');
                hasError = true;
            }
            
            if (hasError) return;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°é–‹å§‹
            Utils.showLoading();
            registerBtn.disabled = true;
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ email, password }),
                    credentials: 'same-origin'
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    Utils.showNotification('ç™»éŒ²ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success', 3000);
                    
                    setTimeout(() => {
                        window.location.href = 'login.html?success=registration_complete';
                    }, 2000);
                    
                } else {
                    const errorMessage = result.error || result.message || 'ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ';
                    Utils.showError(errorMessage);
                    
                    if (result.field) {
                        Utils.showFieldError(result.field, errorMessage);
                    }
                }
                
            } catch (error) {
                console.error('ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    Utils.showError('ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                } else {
                    Utils.showError('ç™»éŒ²å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                }
                
            } finally {
                Utils.hideLoading();
                registerBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
