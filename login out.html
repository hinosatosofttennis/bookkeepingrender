<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ログイン</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <!-- 通知表示用のコンテナ -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden">
        <div id="notification-content" class="px-6 py-3 rounded-lg shadow-lg text-white font-medium">
            <span id="notification-message"></span>
        </div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
                <span class="text-gray-700">ログイン中...</span>
            </div>
        </div>
    </div>

    <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6 text-center">ログイン</h2>
        
        <!-- エラーメッセージ表示エリア -->
        <div id="error-message" class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden">
        </div>
        
        <form id="login-form" novalidate>
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700">メールアドレス</label>
                <input 
                    type="email" 
                    id="email" 
                    required 
                    autocomplete="email"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="example@email.com"
                >
                <div id="email-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>
            
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700">パスワード</label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="password" 
                        required 
                        autocomplete="current-password"
                        minlength="6"
                        class="mt-1 block w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="パスワードを入力"
                    >
                    <button 
                        type="button" 
                        id="toggle-password" 
                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm text-gray-600 hover:text-gray-800"
                        tabindex="-1"
                    >
                        👁️
                    </button>
                </div>
                <div id="password-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>

            <!-- Remember Me & Forgot Password -->
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <input 
                        id="remember-me" 
                        name="remember-me" 
                        type="checkbox" 
                        class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                    >
                    <label for="remember-me" class="ml-2 block text-sm text-gray-700">
                        ログイン状態を保持
                    </label>
                </div>
                <div class="text-sm">
                    <a href="#" id="forgot-password" class="font-medium text-indigo-600 hover:text-indigo-500">
                        パスワードを忘れた方
                    </a>
                </div>
            </div>
            
            <button 
                type="submit" 
                id="login-btn"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                ログイン
            </button>
        </form>
        
        <p class="text-center text-sm mt-4">
            アカウントがありませんか？ <a href="register.html" class="text-indigo-600 hover:underline">新規登録</a>
        </p>
    </div>

    <script>
        // ユーティリティ関数
        const Utils = {
            // 通知表示
            showNotification(message, type = 'info', duration = 5000) {
                const notification = document.getElementById('notification');
                const content = document.getElementById('notification-content');
                const messageEl = document.getElementById('notification-message');
                
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                content.className = `px-6 py-3 rounded-lg shadow-lg text-white font-medium ${colors[type]}`;
                messageEl.textContent = message;
                notification.classList.remove('hidden');
                
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, duration);
            },
            
            // ローディング表示制御
            showLoading() {
                document.getElementById('loading-overlay').classList.remove('hidden');
            },
            
            hideLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
            },
            
            // エラーメッセージ表示
            showError(message) {
                const errorEl = document.getElementById('error-message');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            },
            
            hideError() {
                document.getElementById('error-message').classList.add('hidden');
            },
            
            // フィールドエラー表示
            showFieldError(fieldId, message) {
                const errorEl = document.getElementById(`${fieldId}-error`);
                const inputEl = document.getElementById(fieldId);
                
                if (errorEl && inputEl) {
                    errorEl.textContent = message;
                    errorEl.classList.remove('hidden');
                    inputEl.classList.add('border-red-500');
                }
            },
            
            clearFieldError(fieldId) {
                const errorEl = document.getElementById(`${fieldId}-error`);
                const inputEl = document.getElementById(fieldId);
                
                if (errorEl && inputEl) {
                    errorEl.classList.add('hidden');
                    inputEl.classList.remove('border-red-500');
                }
            },
            
            // バリデーション
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }
        };

        // パスワード表示切替
        document.getElementById('toggle-password').addEventListener('click', () => {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.getElementById('toggle-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = '👁️';
            }
        });

        // リアルタイムバリデーション
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value;
            Utils.clearFieldError('email');
            
            if (email && !Utils.validateEmail(email)) {
                Utils.showFieldError('email', '有効なメールアドレスを入力してください');
            }
        });

        document.getElementById('password').addEventListener('blur', function() {
            const password = this.value;
            Utils.clearFieldError('password');
            
            if (password && password.length < 6) {
                Utils.showFieldError('password', 'パスワードは6文字以上で入力してください');
            }
        });

        // フォーカス時にエラーをクリア
        ['email', 'password'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('focus', () => {
                Utils.clearFieldError(fieldId);
                Utils.hideError();
            });
        });

        // メインのログイン処理
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 既存のエラーをクリア
            Utils.hideError();
            ['email', 'password'].forEach(fieldId => Utils.clearFieldError(fieldId));
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            // クライアントサイドバリデーション
            let hasError = false;
            
            if (!email) {
                Utils.showFieldError('email', 'メールアドレスを入力してください');
                hasError = true;
            } else if (!Utils.validateEmail(email)) {
                Utils.showFieldError('email', '有効なメールアドレスを入力してください');
                hasError = true;
            }
            
            if (!password) {
                Utils.showFieldError('password', 'パスワードを入力してください');
                hasError = true;
            } else if (password.length < 6) {
                Utils.showFieldError('password', 'パスワードは6文字以上で入力してください');
                hasError = true;
            }
            
            if (hasError) return;
            
            // ローディング開始
            Utils.showLoading();
            loginBtn.disabled = true;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest' // CSRFプロテクション
                    },
                    body: JSON.stringify({ email, password, rememberMe }),
                    credentials: 'same-origin' // Cookieを含める
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    // トークンの保存（有効期限も含める）
                    const storage = rememberMe ? localStorage : sessionStorage;
                    storage.setItem('authToken', result.token);
                    
                    if (result.expiresAt) {
                        storage.setItem('tokenExpiry', result.expiresAt);
                    }
                    
                    if (result.user) {
                        storage.setItem('userInfo', JSON.stringify(result.user));
                    }
                    
                    Utils.showNotification('ログインしました', 'success', 2000);
                    
                    // リダイレクト先を決定
                    const redirectUrl = sessionStorage.getItem('redirectAfterLogin') || 'bookkeepingsystem.html';
                    sessionStorage.removeItem('redirectAfterLogin');
                    
                    // 少し待ってからリダイレクト
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 1000);
                    
                } else {
                    // エラーメッセージの表示
                    const errorMessage = result.error || result.message || 'ログインに失敗しました';
                    Utils.showError(errorMessage);
                    
                    // 特定のエラーに対する処理
                    if (result.field) {
                        Utils.showFieldError(result.field, errorMessage);
                    }
                }
                
            } catch (error) {
                console.error('ログインエラー:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    Utils.showError('サーバーに接続できません。インターネット接続を確認してください。');
                } else {
                    Utils.showError('ログイン処理中にエラーが発生しました。時間をおいて再度お試しください。');
                }
                
            } finally {
                Utils.hideLoading();
                loginBtn.disabled = false;
            }
        });

        // パスワードを忘れた場合の処理
        document.getElementById('forgot-password').addEventListener('click', (e) => {
            e.preventDefault();
            // パスワードリセットの処理を実装
            Utils.showNotification('パスワードリセット機能は準備中です', 'info');
        });

        // ページロード時の処理
        document.addEventListener('DOMContentLoaded', () => {
            // 既にログイン済みの場合のチェック
            const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            if (token) {
                const expiry = localStorage.getItem('tokenExpiry') || sessionStorage.getItem('tokenExpiry');
                if (!expiry || Date.now() < new Date(expiry).getTime()) {
                    // 有効なトークンがある場合はメインページにリダイレクト
                    window.location.href = 'bookkeepingsystem.html';
                }
            }
            
            // URLパラメータからエラーメッセージを表示
            const urlParams = new URLSearchParams(window.location.search);
            const error = urlParams.get('error');
            if (error) {
                Utils.showError(decodeURIComponent(error));
            }
        });
    </script>
</body>
</html>

<!-- ===== 新規登録ページ ===== -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新規ユーザー登録</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <!-- 通知表示用のコンテナ -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden">
        <div id="notification-content" class="px-6 py-3 rounded-lg shadow-lg text-white font-medium">
            <span id="notification-message"></span>
        </div>
    </div>

    <!-- ローディングオーバーレイ -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
                <span class="text-gray-700">登録中...</span>
            </div>
        </div>
    </div>

    <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold mb-6 text-center">新規登録</h2>
        
        <!-- エラーメッセージ表示エリア -->
        <div id="error-message" class="mb-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded hidden">
        </div>
        
        <form id="register-form" novalidate>
            <div class="mb-4">
                <label for="email" class="block text-sm font-medium text-gray-700">メールアドレス</label>
                <input 
                    type="email" 
                    id="email" 
                    required 
                    autocomplete="email"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="example@email.com"
                >
                <div id="email-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>
            
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700">パスワード</label>
                <div class="relative">
                    <input 
                        type="password" 
                        id="password" 
                        required 
                        autocomplete="new-password"
                        minlength="8"
                        class="mt-1 block w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="8文字以上のパスワード"
                    >
                    <button 
                        type="button" 
                        id="toggle-password" 
                        class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm text-gray-600 hover:text-gray-800"
                        tabindex="-1"
                    >
                        👁️
                    </button>
                </div>
                <div id="password-error" class="text-red-600 text-sm mt-1 hidden"></div>
                <div class="text-xs text-gray-500 mt-1">
                    8文字以上で、英数字を含めてください
                </div>
            </div>

            <div class="mb-6">
                <label for="confirm-password" class="block text-sm font-medium text-gray-700">パスワード確認</label>
                <input 
                    type="password" 
                    id="confirm-password" 
                    required 
                    autocomplete="new-password"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="パスワードを再入力"
                >
                <div id="confirm-password-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>

            <!-- 利用規約同意 -->
            <div class="mb-6">
                <div class="flex items-center">
                    <input 
                        id="agree-terms" 
                        name="agree-terms" 
                        type="checkbox" 
                        required
                        class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                    >
                    <label for="agree-terms" class="ml-2 block text-sm text-gray-700">
                        <a href="#" class="text-indigo-600 hover:text-indigo-500">利用規約</a>と<a href="#" class="text-indigo-600 hover:text-indigo-500">プライバシーポリシー</a>に同意します
                    </label>
                </div>
                <div id="agree-terms-error" class="text-red-600 text-sm mt-1 hidden"></div>
            </div>
            
            <button 
                type="submit" 
                id="register-btn"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed"
            >
                登録する
            </button>
        </form>
        
        <p class="text-center text-sm mt-4">
            アカウントをお持ちですか？ <a href="login.html" class="text-indigo-600 hover:underline">ログイン</a>
        </p>
    </div>

    <script>
        // ユーティリティ関数（ログインページと同じものを再利用）
        const Utils = {
            showNotification(message, type = 'info', duration = 5000) {
                const notification = document.getElementById('notification');
                const content = document.getElementById('notification-content');
                const messageEl = document.getElementById('notification-message');
                
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                content.className = `px-6 py-3 rounded-lg shadow-lg text-white font-medium ${colors[type]}`;
                messageEl.textContent = message;
                notification.classList.remove('hidden');
                
                setTimeout(() => {
                    notification.classList.add('hidden');
                }, duration);
            },
            
            showLoading() {
                document.getElementById('loading-overlay').classList.remove('hidden');
            },
            
            hideLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
            },
            
            showError(message) {
                const errorEl = document.getElementById('error-message');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            },
            
            hideError() {
                document.getElementById('error-message').classList.add('hidden');
            },
            
            showFieldError(fieldId, message) {
                const errorEl = document.getElementById(`${fieldId}-error`);
                const inputEl = document.getElementById(fieldId);
                
                if (errorEl && inputEl) {
                    errorEl.textContent = message;
                    errorEl.classList.remove('hidden');
                    inputEl.classList.add('border-red-500');
                }
            },
            
            clearFieldError(fieldId) {
                const errorEl = document.getElementById(`${fieldId}-error`);
                const inputEl = document.getElementById(fieldId);
                
                if (errorEl && inputEl) {
                    errorEl.classList.add('hidden');
                    inputEl.classList.remove('border-red-500');
                }
            },
            
            validateEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            },
            
            validatePassword(password) {
                // 8文字以上で英数字を含む
                return password.length >= 8 && /[a-zA-Z]/.test(password) && /[0-9]/.test(password);
            }
        };

        // パスワード表示切替
        document.getElementById('toggle-password').addEventListener('click', () => {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.getElementById('toggle-password');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = '👁️';
            }
        });

        // リアルタイムバリデーション
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value;
            Utils.clearFieldError('email');
            
            if (email && !Utils.validateEmail(email)) {
                Utils.showFieldError('email', '有効なメールアドレスを入力してください');
            }
        });

        document.getElementById('password').addEventListener('input', function() {
            const password = this.value;
            Utils.clearFieldError('password');
            
            if (password && !Utils.validatePassword(password)) {
                Utils.showFieldError('password', '8文字以上で英数字を含めてください');
            }
            
            // 確認パスワードもチェック
            const confirmPassword = document.getElementById('confirm-password').value;
            if (confirmPassword && password !== confirmPassword) {
                Utils.showFieldError('confirm-password', 'パスワードが一致しません');
            } else if (confirmPassword && password === confirmPassword) {
                Utils.clearFieldError('confirm-password');
            }
        });

        document.getElementById('confirm-password').addEventListener('blur', function() {
            const confirmPassword = this.value;
            const password = document.getElementById('password').value;
            Utils.clearFieldError('confirm-password');
            
            if (confirmPassword && password !== confirmPassword) {
                Utils.showFieldError('confirm-password', 'パスワードが一致しません');
            }
        });

        // フォーカス時にエラーをクリア
        ['email', 'password', 'confirm-password', 'agree-terms'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('focus', () => {
                Utils.clearFieldError(fieldId);
                Utils.hideError();
            });
        });

        // メインの登録処理
        const registerForm = document.getElementById('register-form');
        const registerBtn = document.getElementById('register-btn');
        
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // 既存のエラーをクリア
            Utils.hideError();
            ['email', 'password', 'confirm-password', 'agree-terms'].forEach(fieldId => Utils.clearFieldError(fieldId));
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const agreeTerms = document.getElementById('agree-terms').checked;
            
            // クライアントサイドバリデーション
            let hasError = false;
            
            if (!email) {
                Utils.showFieldError('email', 'メールアドレスを入力してください');
                hasError = true;
            } else if (!Utils.validateEmail(email)) {
                Utils.showFieldError('email', '有効なメールアドレスを入力してください');
                hasError = true;
            }
            
            if (!password) {
                Utils.showFieldError('password', 'パスワードを入力してください');
                hasError = true;
            } else if (!Utils.validatePassword(password)) {
                Utils.showFieldError('password', '8文字以上で英数字を含めてください');
                hasError = true;
            }
            
            if (!confirmPassword) {
                Utils.showFieldError('confirm-password', 'パスワード確認を入力してください');
                hasError = true;
            } else if (password !== confirmPassword) {
                Utils.showFieldError('confirm-password', 'パスワードが一致しません');
                hasError = true;
            }
            
            if (!agreeTerms) {
                Utils.showFieldError('agree-terms', '利用規約に同意してください');
                hasError = true;
            }
            
            if (hasError) return;
            
            // ローディング開始
            Utils.showLoading();
            registerBtn.disabled = true;
            
            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({ email, password }),
                    credentials: 'same-origin'
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    Utils.showNotification('登録が完了しました', 'success', 3000);
                    
                    setTimeout(() => {
                        window.location.href = 'login.html?success=registration_complete';
                    }, 2000);
                    
                } else {
                    const errorMessage = result.error || result.message || '登録に失敗しました';
                    Utils.showError(errorMessage);
                    
                    if (result.field) {
                        Utils.showFieldError(result.field, errorMessage);
                    }
                }
                
            } catch (error) {
                console.error('登録エラー:', error);
                
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    Utils.showError('サーバーに接続できません。インターネット接続を確認してください。');
                } else {
                    Utils.showError('登録処理中にエラーが発生しました。時間をおいて再度お試しください。');
                }
                
            } finally {
                Utils.hideLoading();
                registerBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
